<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>리스크 유형 관리 - 어드민 콘솔</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-custom">
        <div class="container-main">
            <div class="d-flex justify-content-between align-items-center w-100">
                <a class="navbar-brand" href="../index.html">AdSafe</a>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-primary fw-bold me-2">어드민 콘솔</span>
                    <div class="dropdown">
                        <button class="btn btn-outline-custom btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="nav-user-btn">
                            <i class="bi bi-person-circle me-1"></i><span id="nav-user-label">사용자</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="../index.html">메인으로</a></li>
                            <li><a class="dropdown-item" href="../account.html">계정 설정</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="../login.html" id="nav-logout">로그아웃</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 사이드바 -->
            <div class="col-md-3 col-lg-2 sidebar-admin">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people me-2"></i>사용자 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="taxonomy.html">
                            <i class="bi bi-diagram-3 me-2"></i>리스크 유형 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ruleset.html">
                            <i class="bi bi-collection me-2"></i>룰셋 버전
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="rules.html">
                            <i class="bi bi-list-check me-2"></i>룰 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="audit.html">
                            <i class="bi bi-journal-text me-2"></i>감사 로그
                        </a>
                    </li>
                </ul>
            </div>

            <!-- 메인 컨텐츠 -->
            <div class="col-md-9 col-lg-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="mb-2">리스크 유형 관리</h1>
                        <p class="text-muted">리스크 분류 체계를 관리합니다.</p>
                    </div>
                    <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addTaxonomyModal">
                        <i class="bi bi-plus-circle me-2"></i>리스크 유형 추가
                    </button>
                </div>

                <div class="card-custom p-0">
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead>
                                <tr>
                                    <th>리스크 코드</th>
                                    <th>대분류</th>
                                    <th>중분류</th>
                                    <th>판정단위</th>
                                    <th>기본 위험도</th>
                                    <th>상태</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="taxonomy-tbody">
                                <tr><td colspan="7" class="text-center py-4 text-muted">불러오는 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 리스크 유형 추가 모달 -->
    <div class="modal fade" id="addTaxonomyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">리스크 유형 추가</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaxonomyForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="add-tax-code" class="form-label">리스크 코드</label>
                                <input type="text" class="form-control form-control-custom" id="add-tax-code" placeholder="RISK_XXX_YYY" required>
                                <small class="text-muted">RISK_로 시작, 대문자/숫자/언더스코어만</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="add-tax-level" class="form-label">기본 위험도</label>
                                <select class="form-select form-control-custom" id="add-tax-level">
                                    <option value="low">낮음</option>
                                    <option value="medium" selected>보통</option>
                                    <option value="high">높음</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="add-tax-level1" class="form-label">대분류</label>
                                <input type="text" class="form-control form-control-custom" id="add-tax-level1" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="add-tax-level2" class="form-label">중분류</label>
                                <input type="text" class="form-control form-control-custom" id="add-tax-level2" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="add-tax-level3" class="form-label">판정단위</label>
                                <input type="text" class="form-control form-control-custom" id="add-tax-level3" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="add-tax-desc" class="form-label">설명</label>
                            <textarea class="form-control form-control-custom" id="add-tax-desc" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">활성화</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="add-tax-active" checked>
                                <label class="form-check-label" for="add-tax-active">활성</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-custom" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary-custom" id="btn-add-save">저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 리스크 유형 수정 모달 -->
    <div class="modal fade" id="editTaxonomyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">리스크 유형 수정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTaxonomyForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">리스크 코드</label>
                                <input type="text" class="form-control form-control-custom" id="edit-tax-code" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-tax-level" class="form-label">기본 위험도</label>
                                <select class="form-select form-control-custom" id="edit-tax-level">
                                    <option value="low">낮음</option>
                                    <option value="medium">보통</option>
                                    <option value="high">높음</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">대분류</label>
                                <input type="text" class="form-control form-control-custom" id="edit-tax-level1">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">중분류</label>
                                <input type="text" class="form-control form-control-custom" id="edit-tax-level2">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">판정단위</label>
                                <input type="text" class="form-control form-control-custom" id="edit-tax-level3">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">설명</label>
                            <textarea class="form-control form-control-custom" id="edit-tax-desc" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">활성화</label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="edit-tax-active">
                                <label class="form-check-label" for="edit-tax-active">활성</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-custom" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary-custom" id="btn-edit-save">저장</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-notice">
        <div class="container-main">
            본 서비스는 참고용이며 법적 판정이 아닙니다. 최종 책임은 사용자에게 있습니다.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../main.js"></script>
    <script>
    (function() {
        var apiBase = (window.ADSAFE_API_URL || '').replace(/\/$/, '');
        var ngrokHeaders = { 'ngrok-skip-browser-warning': 'true' };
        var tbody = document.getElementById('taxonomy-tbody');

        function escapeHtml(s) {
            if (s == null) return '';
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function riskLevelBadge(level) {
            var map = {
                'low': '<span class="badge-custom badge-low">낮음</span>',
                'medium': '<span class="badge-custom badge-medium">보통</span>',
                'high': '<span class="badge-custom badge-high">높음</span>'
            };
            return map[level] || map['medium'];
        }

        function loadTaxonomy() {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">불러오는 중...</td></tr>';
            
            fetch(apiBase + '/api/taxonomy', { headers: ngrokHeaders })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var items = data.items || [];
                    if (items.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">리스크 유형이 없습니다.</td></tr>';
                        return;
                    }
                    
                    tbody.innerHTML = '';
                    items.forEach(function(item) {
                        var tr = document.createElement('tr');
                        var statusBadge = item.isActive 
                            ? '<span class="badge bg-success">활성</span>' 
                            : '<span class="badge bg-secondary">비활성</span>';
                        tr.innerHTML = 
                            '<td><code>' + escapeHtml(item.riskCode) + '</code></td>' +
                            '<td>' + escapeHtml(item.level1 || '') + '</td>' +
                            '<td>' + escapeHtml(item.level2 || '') + '</td>' +
                            '<td>' + escapeHtml(item.level3 || '') + '</td>' +
                            '<td>' + riskLevelBadge(item.riskLevel) + '</td>' +
                            '<td>' + statusBadge + '</td>' +
                            '<td class="text-nowrap"><button class="btn btn-sm btn-outline-secondary btn-edit me-1" ' +
                                'data-code="' + escapeHtml(item.riskCode) + '" ' +
                                'data-level1="' + escapeHtml(item.level1 || '') + '" ' +
                                'data-level2="' + escapeHtml(item.level2 || '') + '" ' +
                                'data-level3="' + escapeHtml(item.level3 || '') + '" ' +
                                'data-risklevel="' + escapeHtml(item.riskLevel || 'medium') + '" ' +
                                'data-desc="' + escapeHtml(item.description || '') + '" ' +
                                'data-active="' + (item.isActive ? '1' : '0') + '"' +
                            '>수정</button> ' +
                            '<button class="btn btn-sm btn-outline-danger btn-delete" ' +
                                'data-code="' + escapeHtml(item.riskCode) + '"' +
                            '>삭제</button></td>';
                        tbody.appendChild(tr);
                    });

                    // 수정 버튼 이벤트
                    tbody.querySelectorAll('.btn-edit').forEach(function(btn) {
                        btn.addEventListener('click', openEditModal);
                    });

                    // 삭제 버튼 이벤트
                    tbody.querySelectorAll('.btn-delete').forEach(function(btn) {
                        btn.addEventListener('click', doDelete);
                    });
                })
                .catch(function(err) {
                    console.error(err);
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-danger">불러오기 실패: ' + escapeHtml(err.message || '') + '</td></tr>';
                });
        }

        // 삭제
        function doDelete(e) {
            var btn = e.currentTarget;
            var riskCode = btn.dataset.code;

            if (!confirm('"' + riskCode + '" 리스크 유형을 삭제하시겠습니까?')) return;

            btn.disabled = true;
            btn.textContent = '삭제 중...';

            fetch(apiBase + '/api/taxonomy/' + encodeURIComponent(riskCode), {
                method: 'DELETE',
                headers: ngrokHeaders
            })
            .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
            .then(function(result) {
                if (result.ok) {
                    alert('삭제 완료되었습니다.');
                    loadTaxonomy();
                } else {
                    alert('삭제 실패: ' + (result.data.error || '알 수 없는 오류'));
                    btn.disabled = false;
                    btn.textContent = '삭제';
                }
            })
            .catch(function(err) {
                alert('삭제 실패: ' + (err.message || '네트워크 오류'));
                btn.disabled = false;
                btn.textContent = '삭제';
            });
        }

        // 수정 모달 열기
        function openEditModal(e) {
            var btn = e.currentTarget;
            document.getElementById('edit-tax-code').value = btn.dataset.code || '';
            document.getElementById('edit-tax-level1').value = btn.dataset.level1 || '';
            document.getElementById('edit-tax-level2').value = btn.dataset.level2 || '';
            document.getElementById('edit-tax-level3').value = btn.dataset.level3 || '';
            document.getElementById('edit-tax-level').value = btn.dataset.risklevel || 'medium';
            document.getElementById('edit-tax-desc').value = btn.dataset.desc || '';
            document.getElementById('edit-tax-active').checked = btn.dataset.active === '1';
            
            var modal = new bootstrap.Modal(document.getElementById('editTaxonomyModal'));
            modal.show();
        }

        // 추가 저장
        document.getElementById('btn-add-save').addEventListener('click', function() {
            var btn = this;
            var riskCode = document.getElementById('add-tax-code').value.trim().toUpperCase();
            var level1 = document.getElementById('add-tax-level1').value.trim();
            var level2 = document.getElementById('add-tax-level2').value.trim();
            var level3 = document.getElementById('add-tax-level3').value.trim();
            var riskLevel = document.getElementById('add-tax-level').value;
            var description = document.getElementById('add-tax-desc').value.trim();
            var isActive = document.getElementById('add-tax-active').checked;

            if (!riskCode || !riskCode.startsWith('RISK_')) {
                alert('리스크 코드는 RISK_로 시작해야 합니다.');
                return;
            }

            btn.disabled = true;
            btn.textContent = '저장 중...';

            fetch(apiBase + '/api/taxonomy', {
                method: 'POST',
                headers: Object.assign({ 'Content-Type': 'application/json' }, ngrokHeaders),
                body: JSON.stringify({
                    riskCode: riskCode,
                    level1: level1,
                    level2: level2,
                    level3: level3,
                    riskLevel: riskLevel,
                    description: description,
                    isActive: isActive
                })
            })
            .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
            .then(function(result) {
                btn.disabled = false;
                btn.textContent = '저장';
                
                if (result.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addTaxonomyModal')).hide();
                    alert('저장 완료되었습니다.');
                    // 폼 초기화
                    document.getElementById('add-tax-code').value = '';
                    document.getElementById('add-tax-level1').value = '';
                    document.getElementById('add-tax-level2').value = '';
                    document.getElementById('add-tax-level3').value = '';
                    document.getElementById('add-tax-desc').value = '';
                    document.getElementById('add-tax-level').value = 'medium';
                    document.getElementById('add-tax-active').checked = true;
                    loadTaxonomy();
                } else {
                    alert('저장 실패: ' + (result.data.error || '알 수 없는 오류'));
                }
            })
            .catch(function(err) {
                btn.disabled = false;
                btn.textContent = '저장';
                alert('저장 실패: ' + (err.message || '네트워크 오류'));
            });
        });

        // 수정 저장
        document.getElementById('btn-edit-save').addEventListener('click', function() {
            var btn = this;
            var riskCode = document.getElementById('edit-tax-code').value;
            var level1 = document.getElementById('edit-tax-level1').value.trim();
            var level2 = document.getElementById('edit-tax-level2').value.trim();
            var level3 = document.getElementById('edit-tax-level3').value.trim();
            var riskLevel = document.getElementById('edit-tax-level').value;
            var description = document.getElementById('edit-tax-desc').value.trim();
            var isActive = document.getElementById('edit-tax-active').checked;

            if (!riskCode) {
                alert('리스크 코드가 없습니다.');
                return;
            }

            btn.disabled = true;
            btn.textContent = '저장 중...';

            fetch(apiBase + '/api/taxonomy/' + encodeURIComponent(riskCode), {
                method: 'PUT',
                headers: Object.assign({ 'Content-Type': 'application/json' }, ngrokHeaders),
                body: JSON.stringify({
                    level1: level1,
                    level2: level2,
                    level3: level3,
                    riskLevel: riskLevel,
                    description: description,
                    isActive: isActive
                })
            })
            .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
            .then(function(result) {
                btn.disabled = false;
                btn.textContent = '저장';
                
                if (result.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('editTaxonomyModal')).hide();
                    alert('저장 완료되었습니다.');
                    loadTaxonomy();
                } else {
                    alert('저장 실패: ' + (result.data.error || '알 수 없는 오류'));
                }
            })
            .catch(function(err) {
                btn.disabled = false;
                btn.textContent = '저장';
                alert('저장 실패: ' + (err.message || '네트워크 오류'));
            });
        });

        // 페이지 로드 시 데이터 가져오기
        loadTaxonomy();
    })();
    </script>
</body>
</html>
