<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>룰셋 버전 - 어드민 콘솔</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <!-- 네비게이션 -->
    <nav class="navbar navbar-custom">
        <div class="container-main">
            <div class="d-flex justify-content-between align-items-center w-100">
                <a class="navbar-brand" href="../index.html">AdSafe</a>
                <div class="d-flex align-items-center gap-3">
                    <span class="text-primary fw-bold me-2">어드민 콘솔</span>
                    <div class="dropdown">
                        <button class="btn btn-outline-custom btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" id="nav-user-btn">
                            <i class="bi bi-person-circle me-1"></i><span id="nav-user-label">사용자</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="../index.html">메인으로</a></li>
                            <li><a class="dropdown-item" href="../account.html">계정 설정</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="../login.html" id="nav-logout">로그아웃</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 사이드바 -->
            <div class="col-md-3 col-lg-2 sidebar-admin">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="users.html">
                            <i class="bi bi-people me-2"></i>사용자 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="taxonomy.html">
                            <i class="bi bi-diagram-3 me-2"></i>리스크 유형 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="ruleset.html">
                            <i class="bi bi-collection me-2"></i>룰셋 버전
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="rules.html">
                            <i class="bi bi-list-check me-2"></i>룰 관리
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="audit.html">
                            <i class="bi bi-journal-text me-2"></i>감사 로그
                        </a>
                    </li>
                </ul>
            </div>

            <!-- 메인 컨텐츠 -->
            <div class="col-md-9 col-lg-10 p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="mb-2">룰셋 버전</h1>
                        <p class="text-muted">룰셋 버전을 관리하고 활성화합니다.</p>
                    </div>
                    <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addRulesetModal">
                        <i class="bi bi-plus-circle me-2"></i>새 버전 생성
                    </button>
                </div>

                <div class="card-custom p-0">
                    <div class="table-responsive">
                        <table class="table table-custom mb-0">
                            <thead>
                                <tr>
                                    <th>버전명</th>
                                    <th>업종</th>
                                    <th>상태</th>
                                    <th>룰 수</th>
                                    <th>생성일</th>
                                    <th>활성화일</th>
                                    <th>작업</th>
                                </tr>
                            </thead>
                            <tbody id="ruleset-tbody">
                                <tr><td colspan="7" class="text-center py-4 text-muted">불러오는 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 룰셋 추가 모달 -->
    <div class="modal fade" id="addRulesetModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">새 룰셋 버전 생성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addRulesetForm">
                        <div class="mb-3">
                            <label for="ruleset-name" class="form-label">버전명</label>
                            <input type="text" class="form-control form-control-custom" id="ruleset-name" placeholder="v2.2.0" required>
                        </div>
                        <div class="mb-3">
                            <label for="ruleset-industry" class="form-label">업종</label>
                            <select class="form-select form-control-custom" id="ruleset-industry">
                                <option value="general">일반</option>
                                <option value="medical">의료</option>
                                <option value="health_supplement">건강기능식품</option>
                                <option value="other">기타</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="ruleset-changelog" class="form-label">변경내역</label>
                            <textarea class="form-control form-control-custom" id="ruleset-changelog" rows="4" placeholder="변경 사항을 입력하세요..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-custom" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary-custom" id="btn-add-ruleset">생성</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 룰셋 상세 모달 -->
    <div class="modal fade" id="detailRulesetModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">룰셋 버전 상세</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-3">버전명</dt>
                        <dd class="col-sm-9" id="detail-versionName">-</dd>
                        <dt class="col-sm-3">업종</dt>
                        <dd class="col-sm-9" id="detail-industry">-</dd>
                        <dt class="col-sm-3">상태</dt>
                        <dd class="col-sm-9" id="detail-status">-</dd>
                        <dt class="col-sm-3">룰 수</dt>
                        <dd class="col-sm-9" id="detail-ruleCount">-</dd>
                        <dt class="col-sm-3">생성일</dt>
                        <dd class="col-sm-9" id="detail-createdAt">-</dd>
                        <dt class="col-sm-3">활성화일</dt>
                        <dd class="col-sm-9" id="detail-activatedAt">-</dd>
                        <dt class="col-sm-3">변경내역</dt>
                        <dd class="col-sm-9" id="detail-changelog">-</dd>
                    </dl>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-custom" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer-notice">
        <div class="container-main">
            본 서비스는 참고용이며 법적 판정이 아닙니다. 최종 책임은 사용자에게 있습니다.
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../main.js"></script>
    <script>
(function() {
    var apiBase = (window.ADSAFE_API_URL || '').replace(/\/$/, '');
    var ngrokHeaders = { 'ngrok-skip-browser-warning': 'true' };
    var tbody = document.getElementById('ruleset-tbody');
    var versionList = [];
    var ruleCountMap = {};

    var statusBadge = {
        active: { label: '활성', class: 'bg-success' },
        inactive: { label: '비활성', class: 'bg-secondary' },
        deprecated: { label: '폐기', class: 'bg-danger' },
        draft: { label: '초안', class: 'bg-warning' }
    };

    var industryLabels = {
        'general': '일반',
        'medical': '의료',
        'health_supplement': '건강기능식품',
        'other': '기타'
    };

    function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        var d = new Date(dateStr);
        if (isNaN(d.getTime())) return dateStr;
        return d.getFullYear() + '.' + String(d.getMonth() + 1).padStart(2, '0') + '.' + String(d.getDate()).padStart(2, '0');
    }

    // 룰셋 버전 목록 로드
    function loadVersions() {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">불러오는 중...</td></tr>';

        fetch(apiBase + '/api/rule-set-versions', { headers: ngrokHeaders })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                versionList = data.items || [];
                // 룰 개수 조회
                return fetch(apiBase + '/api/rules', { headers: ngrokHeaders });
            })
            .then(function(res) { return res.json(); })
            .then(function(rulesData) {
                // 버전별 룰 개수 계산
                ruleCountMap = {};
                (rulesData.items || []).forEach(function(rule) {
                    var vid = rule.versionId;
                    ruleCountMap[vid] = (ruleCountMap[vid] || 0) + 1;
                });
                renderTable();
            })
            .catch(function(err) {
                console.error('버전 로드 실패:', err);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-danger">불러오기 실패</td></tr>';
            });
    }

    function renderTable() {
        if (versionList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">룰셋 버전이 없습니다.</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        versionList.forEach(function(item) {
            var st = statusBadge[item.status] || { label: item.status || '-', class: 'bg-secondary' };
            var ruleCount = ruleCountMap[item.id] || 0;
            var industryLabel = industryLabels[item.industry] || item.industry || '-';
            var activatedAt = item.activatedAt ? formatDate(item.activatedAt) : '-';
            var createdAt = formatDate(item.createdAt);

            var actions = '<button type="button" class="btn btn-sm btn-outline-secondary me-1 btn-detail" data-id="' + item.id + '">상세</button>';
            
            if (item.status === 'active') {
                actions += '<button type="button" class="btn btn-sm btn-outline-secondary btn-deactivate" data-id="' + item.id + '">비활성화</button>';
            } else if (item.status === 'inactive' || item.status === 'draft') {
                actions += '<button type="button" class="btn btn-sm btn-outline-secondary me-1 btn-activate" data-id="' + item.id + '">활성화</button>';
                actions += '<button type="button" class="btn btn-sm btn-outline-secondary btn-delete" data-id="' + item.id + '" data-name="' + escapeHtml(item.versionName) + '">삭제</button>';
            } else if (item.status === 'deprecated') {
                actions += '<button type="button" class="btn btn-sm btn-outline-secondary btn-delete" data-id="' + item.id + '" data-name="' + escapeHtml(item.versionName) + '">삭제</button>';
            }

            var tr = document.createElement('tr');
            tr.innerHTML =
                '<td><strong>' + escapeHtml(item.versionName) + '</strong></td>' +
                '<td>' + escapeHtml(industryLabel) + '</td>' +
                '<td><span class="badge ' + st.class + '">' + escapeHtml(st.label) + '</span></td>' +
                '<td>' + ruleCount + '개</td>' +
                '<td>' + escapeHtml(createdAt) + '</td>' +
                '<td>' + escapeHtml(activatedAt) + '</td>' +
                '<td class="text-nowrap">' + actions + '</td>';
            tbody.appendChild(tr);
        });

        // 이벤트 바인딩
        tbody.querySelectorAll('.btn-detail').forEach(function(btn) {
            btn.addEventListener('click', openDetail);
        });
        tbody.querySelectorAll('.btn-activate').forEach(function(btn) {
            btn.addEventListener('click', doActivate);
        });
        tbody.querySelectorAll('.btn-deactivate').forEach(function(btn) {
            btn.addEventListener('click', doDeactivate);
        });
        tbody.querySelectorAll('.btn-delete').forEach(function(btn) {
            btn.addEventListener('click', doDelete);
        });
    }

    function openDetail(e) {
        var id = parseInt(e.currentTarget.getAttribute('data-id'), 10);
        var item = versionList.find(function(v) { return v.id === id; });
        if (!item) return;

        var st = statusBadge[item.status] || { label: item.status || '-', class: 'bg-secondary' };
        document.getElementById('detail-versionName').textContent = item.versionName || '-';
        document.getElementById('detail-industry').textContent = industryLabels[item.industry] || item.industry || '-';
        document.getElementById('detail-status').innerHTML = '<span class="badge ' + st.class + '">' + st.label + '</span>';
        document.getElementById('detail-ruleCount').textContent = (ruleCountMap[item.id] || 0) + '개';
        document.getElementById('detail-createdAt').textContent = formatDate(item.createdAt);
        document.getElementById('detail-activatedAt').textContent = item.activatedAt ? formatDate(item.activatedAt) : '-';
        document.getElementById('detail-changelog').textContent = item.changelog || '-';

        var modal = new bootstrap.Modal(document.getElementById('detailRulesetModal'));
        modal.show();
    }

    function doActivate(e) {
        var btn = e.currentTarget;
        var id = parseInt(btn.getAttribute('data-id'), 10);
        if (!confirm('이 버전을 활성화하시겠습니까? 현재 활성 버전은 비활성화됩니다.')) return;

        btn.disabled = true;
        btn.textContent = '처리 중...';

        fetch(apiBase + '/api/rule-set-versions/' + id + '/activate', {
            method: 'PUT',
            headers: ngrokHeaders
        })
        .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
        .then(function(result) {
            if (result.ok) {
                alert('활성화 완료되었습니다.');
                loadVersions();
            } else {
                alert('활성화 실패: ' + (result.data.error || '알 수 없는 오류'));
                btn.disabled = false;
                btn.textContent = '활성화';
            }
        })
        .catch(function(err) {
            alert('활성화 실패: ' + (err.message || '네트워크 오류'));
            btn.disabled = false;
            btn.textContent = '활성화';
        });
    }

    function doDeactivate(e) {
        var btn = e.currentTarget;
        var id = parseInt(btn.getAttribute('data-id'), 10);
        if (!confirm('이 버전을 비활성화하시겠습니까?')) return;

        btn.disabled = true;
        btn.textContent = '처리 중...';

        fetch(apiBase + '/api/rule-set-versions/' + id + '/deactivate', {
            method: 'PUT',
            headers: ngrokHeaders
        })
        .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
        .then(function(result) {
            if (result.ok) {
                alert('비활성화 완료되었습니다.');
                loadVersions();
            } else {
                alert('비활성화 실패: ' + (result.data.error || '알 수 없는 오류'));
                btn.disabled = false;
                btn.textContent = '비활성화';
            }
        })
        .catch(function(err) {
            alert('비활성화 실패: ' + (err.message || '네트워크 오류'));
            btn.disabled = false;
            btn.textContent = '비활성화';
        });
    }

    function doDelete(e) {
        var btn = e.currentTarget;
        var id = btn.getAttribute('data-id');
        var name = btn.getAttribute('data-name');

        if (!confirm('"' + name + '" 버전을 삭제하시겠습니까?\n연결된 룰도 함께 삭제됩니다.')) return;

        btn.disabled = true;
        btn.textContent = '삭제 중...';

        fetch(apiBase + '/api/rule-set-versions/' + encodeURIComponent(id), {
            method: 'DELETE',
            headers: ngrokHeaders
        })
        .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
        .then(function(result) {
            if (result.ok) {
                alert('삭제 완료되었습니다.' + (result.data.deletedRules > 0 ? ' (연결된 룰 ' + result.data.deletedRules + '개 함께 삭제)' : ''));
                loadVersions();
            } else {
                alert('삭제 실패: ' + (result.data.error || '알 수 없는 오류'));
                btn.disabled = false;
                btn.textContent = '삭제';
            }
        })
        .catch(function(err) {
            alert('삭제 실패: ' + (err.message || '네트워크 오류'));
            btn.disabled = false;
            btn.textContent = '삭제';
        });
    }

    // 룰셋 버전 추가
    document.getElementById('btn-add-ruleset').addEventListener('click', function() {
        var btn = this;
        var name = document.getElementById('ruleset-name').value.trim();
        var industry = document.getElementById('ruleset-industry').value;
        var changelog = document.getElementById('ruleset-changelog').value.trim();

        if (!name) {
            alert('버전명을 입력하세요.');
            return;
        }

        btn.disabled = true;
        btn.textContent = '생성 중...';

        fetch(apiBase + '/api/rule-set-versions', {
            method: 'POST',
            headers: Object.assign({ 'Content-Type': 'application/json' }, ngrokHeaders),
            body: JSON.stringify({
                versionName: name,
                industry: industry,
                changelog: changelog,
                status: 'draft'
            })
        })
        .then(function(res) { return res.json().then(function(data) { return { ok: res.ok, data: data }; }); })
        .then(function(result) {
            btn.disabled = false;
            btn.textContent = '생성';

            if (result.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addRulesetModal')).hide();
                alert('룰셋 버전이 생성되었습니다.');
                document.getElementById('ruleset-name').value = '';
                document.getElementById('ruleset-changelog').value = '';
                document.getElementById('ruleset-industry').value = 'general';
                loadVersions();
            } else {
                alert('생성 실패: ' + (result.data.error || '알 수 없는 오류'));
            }
        })
        .catch(function(err) {
            btn.disabled = false;
            btn.textContent = '생성';
            alert('생성 실패: ' + (err.message || '네트워크 오류'));
        });
    });

    // 초기화
    loadVersions();
})();
    </script>
</body>
</html>
